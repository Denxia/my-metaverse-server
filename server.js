// 1. μ°λ¦¬κ°€ μ„¤μΉν• 'ws'λΌλ” λ¶€ν’(λΌμ΄λΈλ¬λ¦¬)μ„ κ°€μ Έμµλ‹λ‹¤.
const WebSocket = require('ws');

// 2. 8080λ² ν¬νΈλ¥Ό μ‚¬μ©ν•λ” μ›Ήμ†μΌ“ μ„λ²„λ¥Ό λ§λ“­λ‹λ‹¤.
//    ν¬νΈλ” μ°λ¦¬ μ§‘μ μ—¬λ¬ κ°μ λ¬Έ μ¤‘ ν•λ‚λΌκ³  μƒκ°ν•λ©΄ μ‰½μµλ‹λ‹¤. 8080λ² λ¬ΈμΌλ΅λ§ μ†λ‹(ν΄λΌμ΄μ–ΈνΈ)μ„ λ°›κ² λ‹¤λ” λ»μ…λ‹λ‹¤.
const wss = new WebSocket.Server({ port: 8080 });

// 3. 'wss' μ¦‰, μ°λ¦¬ μ„λ²„μ— λ„κµ°κ°€ μ ‘μ†(connection)μ„ μ‹λ„ν•λ©΄ μ–΄λ–¤ ν–‰λ™μ„ ν• μ§€ μ •μν•©λ‹λ‹¤.
wss.on('connection', ws => {
  // 'ws'λ” μ ‘μ†ν• ν• λ…μ ν΄λΌμ΄μ–ΈνΈλ¥Ό μλ―Έν•©λ‹λ‹¤.

  console.log('μƒλ΅μ΄ ν΄λΌμ΄μ–ΈνΈκ°€ μ ‘μ†ν–μµλ‹λ‹¤.'); // μ„λ²„ κ΄€λ¦¬μλ§ λ³Ό μ μλ” λ΅κ·Έ

  // 4. μ ‘μ†ν• ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ©”μ‹μ§€(message)κ°€ λ„μ°©ν–μ„ λ• μ–΄λ–¤ ν–‰λ™μ„ ν• μ§€ μ •μν•©λ‹λ‹¤.
  ws.on('message', message => {
    console.log(`ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ°›μ€ λ©”μ‹μ§€: ${message}`);

    // μ—¬κΈ°μ„ κ°€μ¥ μ¤‘μ”ν• λ¶€λ¶„!
    // λ©”μ‹μ§€λ¥Ό λ³΄λ‚Έ ν΄λΌμ΄μ–ΈνΈμ—κ²λ§ λ‹µμ¥ν•λ” κ² μ•„λ‹λΌ,
    // μ°λ¦¬ μ„λ²„μ— μ ‘μ†λ "λ¨λ“ " ν΄λΌμ΄μ–ΈνΈμ—κ² λ°›μ€ λ©”μ‹μ§€λ¥Ό κ·Έλ€λ΅ λ‹¤μ‹ λ³΄λ‚΄μ¤λ‹λ‹¤. (λΈλ΅λ“μΊμ¤ν…)
    wss.clients.forEach(client => {
      // μ ‘μ†λ ν΄λΌμ΄μ–ΈνΈλ“¤(wss.clients)μ„ ν• λ…μ”©(client) λμ•„κ°€λ©΄μ„
      if (client.readyState === WebSocket.OPEN) { // ν΄λΌμ΄μ–ΈνΈμ μƒνƒκ°€ 'μ—°κ²° μ¤‘'μΌ λ•λ§
        client.send(message.toString()); // λ°›μ€ λ©”μ‹μ§€λ¥Ό κ·Έλ€λ΅ λ³΄λ‚΄μ¤€λ‹¤.
      }
    });
  });

  // 5. ν΄λΌμ΄μ–ΈνΈμ μ ‘μ†μ΄ λμ–΄μ΅μ„ λ•(close) μ–΄λ–¤ ν–‰λ™μ„ ν• μ§€ μ •μν•©λ‹λ‹¤.
  ws.on('close', () => {
    console.log('ν΄λΌμ΄μ–ΈνΈ ν• λ…μ μ ‘μ†μ΄ λμ–΄μ΅μµλ‹λ‹¤.');
  });

  // 6. μ ‘μ† μ§ν›„ ν™μ λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄μ¤λ‹λ‹¤.
  ws.send('λ©”νƒ€λ²„μ¤ μ„λ²„μ— μ¤μ‹  κ²ƒμ„ ν™μν•©λ‹λ‹¤!');
});

// μ„λ²„κ°€ μ μΌμ΅λ”μ§€ ν™•μΈν•κΈ° μ„ν• λ΅κ·Έ
console.log('π€ μ„λ²„κ°€ 8080 ν¬νΈμ—μ„ λ‹Ήμ‹ μ„ κΈ°λ‹¤λ¦¬κ³  μμ–΄μ”...');